{% extends "base.html" %}
{% block js_content %}
    <script src="/static/js/TlibJSFixedHeaderTable3.js?q={{ appVer }}" type="text/javascript"></script>
{% endblock %}
{% block header_name %} {{ header_name }} {% endblock %}
{% block container_content %}
    <style type="text/css">
        body {
            overflow: hidden;
        }

        .header-content {
            padding-bottom: 10px;
            overflow: hidden;
        }

        .main-content {
            height: 100%;
            width: 100%;
        }

        .search-result {
            overflow: hidden;
            height: 100%;
        }

        .search-result-div {
            height: 100%;
            overflow: auto;
            padding-top: 0px;
        }

        .form-inline {
            white-space: nowrap;
            padding-bottom: 10px;
        }

        .form-inline .form-control {
            display: inline-block;
            width: auto;
            vertical-align: middle;
            border-color: black;
        }

        .form-inline .form-group {
            margin-left: 30px;
        }

        .form-inline .form-group.h5-text {
            margin-left: 10px;
            margin-right: 10px;
        }

        .form-inline select {
            min-width: 80px;
        }

        .form-inline input[type='text'] {
            width: 160px;
        }

        input[type="radio"], input[type="checkbox"] {
            margin: 0;
        }

        input, select {
            font-family: 'MS Gothic', Sans-serif;
            height: auto !important;
        }

        thead th {
            text-align: center;
            background-color: #DAE8EE;
        }

        td, th {
            min-width: 34px;
        }

        thead th {
            font-size: 12px;
            font-weight: 300;
        }

        .table-bordered > thead > tr > th, table-bordered > tbody > tr > th, .table-bordered > tfoot > tr > th, .table-bordered > thead > tr > td, .table-bordered > tbody > tr > td, .table-bordered > tfoot > tr > td {
            border: 1px solid black;
        }

        .date {
            width: 35px;
            height: 29px;
        }

        div.condition_area {
            float: left;
        }

        .btn-search {
            font-size: 18px;
            position: relative;
            margin-top: 20px;
        }

        .yellow {
            background: #e6e680e6;
        }

        table.schedule-table th.no_border {
            background-color: #fff;
            padding-top: 0px;
            padding-bottom: 0px;
        }

        tr.fixed_table_header {
            height: 30px;
        }

        /* jqModal用CSS */
        .jqmWindow {
            width: 800px !important;
            min-height: 500px !important;
            max-height: 80% !important;
        }
    </style>

    <div class="row">
        <h5>
            <a href="{{ url_for('main') }}"> HOME </a> > Outage Schedule
        </h5>
    </div>
    <div class="row">
        <form id="schedule_form" name="schedule_form" action="{{ url_for('outage_schedule') }}" method="post">
            <div class="header-content" id="schedule_form-headerContents">
                <div class="condition_area">
                    <div class="form-inline">
                        <div class="form-group">
                            {{ form.country.label(class="control-label") }}
                            {{ form.country(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.plant.label(class="control-label") }}
                            {{ form.plant(class="form-control") }}
                        </div>
                        <div class="form-group">
                            {{ form.c1(class="form-control") }}
                            {{ form.c1.label(class="control-label") }}
                        </div>
                        <div class="form-group">
                            {{ form.c2(class="form-control") }}
                            {{ form.c2.label(class="control-label") }}
                        </div>
                        <div class="form-group">
                            {{ form.c3(class="form-control") }}
                            {{ form.c3.label(class="control-label") }}
                            {{ form.c4(class="form-control") }}
                            {{ form.c4.label(class="control-label") }}
                        </div>
                    </div>
                    <div class="form-inline">
                        <div class="form-group">
                            <label>Period
                                {{ form.date_start(class="form-control") }}
                                <span style="padding: 0 10px 0 10px;">～</span>
                                {{ form.date_end(class="form-control") }}
                            </label>
                        </div>
                    </div>
                </div>
                <div class="right-header-btn">
                    <div class="form-group" style="vertical-align: bottom;">
                        {#                    <button type="submit" class="btn btn-info btn-lg" style="padding: 0px 15px; font-size: 30px;">Search</button>#}
                        {{ form.search(class="btn btn-info btn-search") }}
                        {% if menu_param["outage_schedule_list"] %}
                            <button type="button" class="btn btn-info btn-search" onclick="addOutageSchedule();">Add
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if menu_param["outage_schedule_list"] %}
                <div class="search-result-div clear-float">
                    <div class="row" id="schedule_form-schedule_list">
                        <table class="table-bordered schedule-table">
                            <thead>
                            <tr>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                <th class="no_border"></th>
                                {% for foo in range(menu_param["year_count"]*12) %}
                                    <th class="no_border"></th>
                                {% endfor %}
                            </tr>
                            <tr style="height: 30px;">
                                <th colspan="3"></th>
                                <th colspan="3">M</th>
                                <th colspan="3">E</th>
                                {% for year in range(menu_param.min_year,menu_param.max_year+1) %}
                                    <th colspan="12">{{ year }}</th>
                                {% endfor %}
                            </tr>
                            <tr align="center" style="height: 30px;">
                                <th class="NW">Plant Code</th>
                                <th class="NW">Country</th>
                                <th class="NW">Unit</th>
                                <th class="NW" colspan="2">PR</th>
                                <th class="NW">stts</th>
                                <th class="NW" colspan="2">PR</th>
                                <th class="NW">stts</th>
                                {% for year in range(menu_param["year_count"]) %}
                                    <th>Jan</th>
                                    <th>Feb</th>
                                    <th>Mar</th>
                                    <th>Apr</th>
                                    <th>May</th>
                                    <th>Jun</th>
                                    <th>Jul</th>
                                    <th>Aug</th>
                                    <th>Sep</th>
                                    <th>Oct</th>
                                    <th>Nov</th>
                                    <th>Dec</th>
                                {% endfor %}
                            </tr>
                            </thead>
                            <tbody>
                            {% for schedule in menu_param['outage_schedule_list'] %}
                                <tr id="{{ schedule.turbine_id }}" data_type="{{ schedule.data_type }}">
                                    <td class="NW"><a href="#">{{ schedule.plant_cd or '' }}</a></td>
                                    <td class="NW">{{ schedule.country_nm or '' }} {{ schedule.cnt }}</td>
                                    <td class="NW">{{ schedule.plant_name or '' }}</td>
                                    <td class="NW AC"></td>
                                    <td class="NW red"></td>
                                    <td class="NW AR"></td>
                                    <td class="NW AC"></td>
                                    <td class="NW"></td>
                                    <td class="NW AR"></td>
                                    {% for cell in schedule.cells %}
                                        <td class="NW date td_link"
                                            style="padding: 0px !important;"
                                                {% if cell.color != 'gray' %}
                                                    {% if cell.length > 1 %}
                                            onclick="outageScheduleList('{{ cell.teiken_ids_str }}');"
                                                    {% else %}
                                            onclick="outage_schedule_detail('{{ schedule.turbine_id }}', '{{ schedule.teiken_id }}', 'NEWWINDOW');"
                                                    {% endif %}
                                                {% else %}
                                            onclick="addOutageByStartStr(this,'{{cell.label }}');"
                                                {% endif %}>
                                            <img width="100%" src="{{ cell.img_src }}">
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% elif "POST" == request.method %}
                <div class="required">該当データがありません.</div>
            {% endif %}
        </form>
    </div>
    <script>
        //<![CDATA[
        $(function () {
            $("input").keypress(function (ev) {
                if (ev.which && ev.which === 13 || ev.keyCode && ev.keyCode === 13) {
                    return false;
                } else {
                    return true;
                }
            });
            {% if menu_param["outage_schedule_list"] %}
                fixedResultTable();
            {% endif %}
        });

        function fixedResultTable() {
            var fixedHeaderCols = 9;

            initTlibJSFixedHeaderTable(
                {
                    table_div: 'schedule_form-schedule_list',
                    header_cols: fixedHeaderCols,
                    bg_color: ''
                });
            initResultListClick();
        }

        // 予定選択画面「jqModal」
        function outageScheduleList(teiken_ids_str) {
            var url = '{{url_for("outage_schedule_jqmodal")}}';
            var modal = $("#jqmWindow").jqm().css("opacity", "0").jqmShow();
            $.post(url, {teiken_ids_str: teiken_ids_str})
                .done(function (data) {
                    modal.html(data);
                    var l = ($(window).width() / 2) - (modal.width() / 2);
                    var t = ($(window).height() / 2) - (modal.height() / 2);
                    modal.css("left", l).css("top", t).jqDrag(".jqDnRHandle").css("opacity", "1.0");
                });
            {#load_jqmodal_dlg(url, on_load_jqmodal_dlg)#}
        }

        // 予定追加
        function addOutageSchedule() {
            var $selectedTrs = $("#schedule_form-schedule_list .data_selected");
            if ($selectedTrs.length != 1) {
                alert('一行を選択してください。');
            } else {
                var url = '{{url_for("outage_schedule_add")}}';
                var param_str = $.param({
                    turbine_id: $selectedTrs.attr("id"),
                    data_type: $selectedTrs.attr("data_type"),
                    date_start: $("#date_start").val(),
                    date_end: $("#date_end").val(),
                });
                var path = url + "?" + param_str;
                window.open(path,"_blank");
            }
        }
        // 予定追加
        function addOutageByStartStr(self,startStr) {
            var url = '{{url_for("outage_schedule_add")}}';
            var param_str = $.param({
                    turbine_id: $(self).parent("tr").attr("id"),
                    data_type: $(self).parent("tr").attr("data_type"),
                    outage_start:startStr.substr(0,4)+"/"+startStr.substr(-2)+"/01",
                    date_start: $("#date_start").val(),
                    date_end: $("#date_end").val(),
                });
            var path = url + "?" + param_str;
                window.open(path,"_blank");
        }
        // 再検索をします
        function search() {
            $("#search").click()
        }

        //]]>
    </script>
    <div class="jqmWindow" id="jqmWindow"></div>
    <div id="confirm">
        <div class="header"><span>Confirm</span></div>
        <div class="message"></div>
        <div class="buttons middleBtnArea float_none width_170">
            <div class="btn btn-default yes float_none">Yes</div>
            <div class="btn btn-default no simplemodal-close float_none">No</div>
        </div>
    </div>
    <div id="alert">
        <div class="header"><span>Alert</span></div>
        <div class="message"></div>
        <div class="buttons middleBtnArea">
            <div class="btn btn-default no simplemodal-close">OK</div>
        </div>
    </div>
{% endblock %}